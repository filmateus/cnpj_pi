---
title: "Análise de sobrevivência para o fechamento das empresas no Piauí a partir de 2010"
format: html
---

```{r}
#| message: false
#| warning: false
#| results: hide


knitr::opts_chunk$set(
  fig.width=12, fig.height=6,
  #out.width = "100%",
  cache = TRUE,
  #echo = FALSE,
  message = FALSE,
  warning = FALSE,
  hiline = TRUE,
  cache.lazy = FALSE,
  fig.pos = "H"
)

library(formattable)
library(tidyverse)
library(lubridate)
library(sf)
```


```{r}
nat_jud = qsacnpj::tab_natureza_juridica
nat_jud$cod_subclass_natureza_juridica = as.numeric(nat_jud$cod_subclass_natureza_juridica)

cnae = qsacnpj::tab_cnae
cnae$cod_cnae = as.integer(cnae$cod_cnae)

empresas = read.csv('bq-empresas.csv')|>
  dplyr::left_join(nat_jud, 
                   by = c("natureza_juridica" = "cod_subclass_natureza_juridica"))|>
  dplyr::filter(nm_natureza_juridica %in% c("Entidades Empresariais"))|>
  dplyr::distinct()

analise_survive = read.csv('bq-estabelicimentos.csv')|>
                dplyr::semi_join(empresas, by = "cnpj_basico")|>
                dplyr::filter(situacao_cadastral == 8, 
                              identificador_matriz_filial == 1, 
                              data_situacao_cadastral > '2009-12-31')
```

Este projeto busca fazer uma análise de sobrevivência das empresas no estado piauí que tiveram os CNPJ's (Cadastro Nacional de Pessoas Juríricas) dados baixa, ou seja, a empresa teve suas atividades finalizadas. Os dados da Receita federal se iniciam na década de 1960, entretanto, restrigimos a análise para o fechamentos a partir do ano de 2010, totalizando `r dim(analise_survive)[1]` empresas. Essa restrição tem como objetivo obtermos um perfil das empresas mais atualizado.

A década de 2010 foi um período marcado por avanços tecnológicos, como a popularização do celular e do uso da internet, transformando o mercado. Essa transformação foi fortalecida na pandemia do covid-19, situação que exigiu muito para as empresas para sobreviver ao períodos que foram obrigadas a não ter atividades presenciais.

Os dados possuem sua base no site da Receita Federal, entretanto, utilizamos uma base já tratada disponibilizada pelo site `Base de dados` 


# Fechamentos de empresas desde  2010

```{r}
analise_survive|>
    dplyr::mutate(data_situacao_cadastral = ymd(data_situacao_cadastral))|>
    dplyr::mutate(mes_atividade = floor_date(data_situacao_cadastral, "quarter"),
                  ano_atividade = floor_date(data_situacao_cadastral, "year"))|>
    dplyr::filter(mes_atividade >= "2010-01-01", 
                 mes_atividade <= "2022-10-01")|>
    count(ano_atividade)|>
    dplyr::mutate(mes_atividade = ano_atividade)|>
    filter(year(mes_atividade) >= 2010)|>
    ggplot(aes(x = mes_atividade, y = n))+
    geom_line(size=1, color = "red")+
    theme_minimal(10)+
    scale_x_date(breaks = scales::date_breaks("2 year"),
                 labels = scales::date_format("%Y"))+
    labs(x = "Ano",
         y = "Empresas Fechadas (milhares)") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1, size=10),
          axis.title.x = element_text(size=20),
          axis.title.y = element_text(size=20),
          legend.key.size = unit(1.3, 'cm'),
          legend.key.width = unit(1,"cm"),
          legend.title = element_text(size=15),
          legend.text = element_text(size=10),
          panel.grid.minor.x = element_blank())+
     geom_text(aes(label = n), vjust=-0.5)
```

Através do gráfico do fechamento por ano, percebemos que entre 2010 e 2012, há um comportamento estabilizado do número de empresas fechadas com média de 1174 empresas. Entretanto, em 2013, há um aumento de 117% em relação ao ano anterior, o comportamento que se inicia é de aumento do número de baixas de CNPJ's, tendo dois picos que quebram uma sequência linear, em 2015 e 2018, com 10.146 e 16.597 empresas que tiveram o registro baixado pela Receita Federal.

Buscando uma explicação para esses dados discrepantes, temos que no dia 01/02/2018, houve 10423 baixas, resultado da ADE (Ato Declatório Executivo) 01/2018 que deu baixa automática em registros que não estavam regularizados até 26 de janeiro de 2018. Não foi encontrado nada para o ano de 2015, todavia em 09/02/2015, houve 6475 baixas, um número bastante elevado, indicando uma data onde foi procedimento parecido com o ano de 2018. Para dias normais, o pico foi em 28/04/2022 com 115 baixas, sendo a média diária de 16 empresas com registro baixado. 

# Período de funcionamento 

Para compreender o tempo de funcionamento das empresas, temos o gráfico e utilizamos a função `summary`. A unidade de medida escolhida foi de anos para obtermos uma amplitude menor, mas fiel a diferença entre o menor período de funcionamento, 0 anos, e maior período, de 56 anos. Podíamos utilizar dias, por exemplo, mas com valores muito altos.

```{r}
# contando o período de funcionamento
periodo = 
analise_survive|>
        dplyr::mutate(data_situacao_cadastral = ymd(data_situacao_cadastral),
                      data_inicio_atividade = ymd(data_inicio_atividade))|>
        dplyr::filter(situacao_cadastral == 8,
        identificador_matriz_filial == 1)|>
        dplyr::mutate(Período  = lubridate::interval(data_inicio_atividade, 
                                                     data_situacao_cadastral)/years(1))|>
        dplyr::select(Período)|>
        dplyr::mutate(Período = round(as.numeric(Período), 0))

# gráfico        
ggplot(periodo, aes(x = Período))+
geom_histogram(binwidth=1, colour = "black", fill = "gold")+
theme_classic()

# resumo das medidas
summary(periodo$Período)
```


Obtemos que a média de funcionamento das empresas é 6,55 anos, mas a mediana é de 3,65 anos. Essa difereça é explicada pelo a influência que os valores do último quantil, onde estão os os valores 25% mais altos da distribuição dos dados, tem sobre a média.

Obvesevamos que até 75% das empresas funcionaram por 7,5 anos, logo a amplitude é de 7,5. Todavia para os dados que no ultimo quantial, temos que valor final é 56 anos, resultando numa amplitude 49 anos. Quantitamente, neste quantil, temos  21.772 empresas. 

Resumidante, a maioria das empresas, 75 %, funcionam até 7 anos e 50%, somente 3 anos, no que consiste em períodos baixos de funcionamento.

# Ano de abertura e fechamento

Abaixo, temos na linha vertical o ano de abertura da empresa e na horizontal o ano de fechamento.

Alguns dados que podemos identificar é o ano de 2021 é o ano de com mais empresas que tiveram menos de 1 de funcionamento, com 2096 que abriram e fecharam neste mesmo ano. 

Entendendo quais foram as empresas que foram fechadas no ano de 2018 e que explixam o pico deste ano, podemos vizualizar valores altos a partir do ano de abertura de 2010, são valores que passam dos 1500 empresas fechadas e, de 2011 até 2014, os valores ultrapassam a barreira do 2300. São os valores mais altos registrados. Esse coportamento indica que a maioria das empresas que tiveram a baixa no CNPJ's em 2018 não tinham mais de 8 anos de funcionamento. 


```{r}
table(year(analise_survive$data_inicio_atividade), 
      year(analise_survive$data_situacao_cadastral))|>
  as.data.frame.matrix()|>
  kableExtra::kbl()|>
  kableExtra::kable_paper(full_width = F)
```

A empresa com o maior tempo de registro iniciou as atividades em 1956, dando baixa em 2010. Foram 56 anos de cnpj ativo.(Por curiosidade, na pesquisa consta o nome fantasia *Armazem dois irmãos*).


# Onde as empresas fecharam

O estado do Piauí é uma UF que possui um polo econômico destacado em toda sua área. A capital Teresina possui 46% dos CNPJ's cadastrados, e os outros 54% são divididos entre os 223 municípios restantes. A capital é mundo a parte e, depedendo da pesquisa, precisa ser trabalhada de forma isolada por causa da discrepância dos números comparado a todas as cidades do interior reunidas. 


```{r}
#| message: false
#| warning: false
#| results: hide

library(geobr)

all_mun_pi <- read_municipality(code_muni=22, year=2018)

dates_pi = analise_survive|>
            group_by(id_municipio)|>
            summarise("Quantidade" = n())|>
            dplyr::mutate("Percentual" = Quantidade*100/sum(Quantidade))|>
            #dplyr::rename("code_muni" = "id_municipio")|>
            dplyr::left_join(all_mun_pi, by=c("id_municipio"= "code_muni"))

min_empresas = min(dates_pi$Quantidade)
max_empresas = max(dates_pi$Quantidade)
min_percentual = min(dates_pi$Percentual)
max_percentual = max(dates_pi$Percentual)

ggplot() +
geom_sf(data = dates_pi,  aes(fill=Percentual, geometry = geom))+
scale_fill_viridis_c(direction = -1, limits = c(min_percentual,max_percentual))+
labs(title= "Empresas Fechadas: 2010 - 2022",
     subtitle = "Percentual") +
theme_bw()
```

Teresina foi responsável por 43,83% das empresas fechadas, em segundo lugar está Parnaíba com 6,3%. Ao lermos a tabela, percebemos que somente as 10 primeiras cidade ultrapassam 1% do total das empresas com baixa registral. 


## Top 10

```{r}
dates_pi$Percentual = round(dates_pi$Percentual, 2)

dates_pi|>
  dplyr::select(name_muni, Quantidade, Percentual)|>
  dplyr::arrange(desc(Quantidade))|>
  head(10)|>knitr::kable()
```

## Cidade com menos empreedimentos fechados

```{r}
dates_pi|>
  dplyr::select(name_muni, Quantidade, Percentual)|>
  dplyr::arrange(desc(Quantidade))|>
  tail(10)|>knitr::kable()
```


# Tipo de empreendimentos fechados. 

Uma informação importante é qual o tipo de empreendimento está fechando, dessa forma, podemos conhecer qual tipo de mercado mais sofre com os fechamentos. No Brasil, há o CNAE - Classificação Nacional de Atividades Econômicas - que determina a área de atuação da atividade empresarial, ou seja, é um código que atribui um conjunto de atividades desempenhadas pelo empresário. No gráfico a seguir, temos que o comercio varejista é o mais afetado com a descontinuidade dos empreendimentos, seguido peo ramo alimenticío. 


```{r}
cnae = qsacnpj::tab_cnae
cnae$cod_cnae = as.integer(cnae$cod_cnae)

analise_survive|>
    dplyr::rename("cod_cnae" = "cnae_fiscal_principal")|>
    left_join(cnae, "cod_cnae")|>
    dplyr::filter(!is.na(nm_classe))|>
    dplyr::mutate(tipo = fct_lump(nm_divisao,11, other_level = "Outras")) %>% 
    dplyr::count(tipo) %>%
    dplyr::mutate(tipo = fct_reorder(str_wrap(tipo, 45), n))|>
    dplyr::mutate(prop = percent(n/sum(n)))|>
    ggplot(aes(x = tipo, y = n/1e3))+
    geom_col(fill = 'gold', alpha = .9, width = 0.9) +
      coord_flip() +
      geom_text(aes(label = prop), nudge_y = 1.1) +
      theme_minimal(5) +
      labs(x = "Atividade principal", 
           y = "Quantidade de empresas (milhares)")+
      theme(axis.title.x = element_text(size=20),
            axis.title.y = element_text(size=20),
            axis.text.x = element_text(size = 10),
            axis.text.y = element_text(size = 9)
            )
```

## Divisão do Comércio Varejista. 

Comercio Varejista é um termo abrangente, para compreender melhor quais tipos de comercios são afetados, realizamos um filtragem  para varejistas. Nota-se que o ramo de confeçções é o mais afetado, seguido por comércios de alimentos, ou pequenas merceárias. 

```{r}
analise_survive|>
    dplyr::rename("cod_cnae" = "cnae_fiscal_principal")|>
    left_join(cnae, "cod_cnae")|>
    dplyr::filter(!is.na(nm_classe))|>
    dplyr::filter(nm_divisao == "COMÉRCIO VAREJISTA")|>
    dplyr::mutate(tipo = fct_lump(nm_classe,11, other_level = "Outras")) %>% 
    dplyr::count(tipo) %>%
    dplyr::mutate(tipo = fct_reorder(str_wrap(tipo, 45), n))|>
    dplyr::mutate(prop = percent(n/sum(n)))|>
    ggplot(aes(x = tipo, y = n/1e3))+
    geom_col(fill = 'gold', alpha = .9, width = 0.9) +
      coord_flip() +
      geom_text(aes(label = prop), nudge_y = 0.3) +
      theme_minimal(7) +
      labs(x = "Atividade principal", 
           y = "Quantidade de empresas (milhares)")+
      theme(axis.title.x = element_text(size=20),
            axis.title.y = element_text(size=20),
            axis.text.x = element_text(size = 10),
            axis.text.y = element_text(size = 9)
            )
```



Em relação a classificação outros, é importante descatacar que existe muitas classificações e muitas, algumas vezes, possuem somente uma empresa cadastrada, gerando uma lista muito grande. No gráfico acima, temos as 11 classificações mais comuns, e correspondem a 79% de todos os comercios varejista. 

# Capital Social

problema: 12.306 empresas com capital social de valor 0

```{r}
analise_survive|>
    left_join(empresas, "cnpj_basico")|>#View()
    #dplyr::filter(capital_social > 50)|>
    dplyr::mutate(capital_social_cat = cut(capital_social/1e3, 
                                           breaks = c(0, 1e3, 1e4, 1e5, 1e6, Inf)/1e3,
                                           include.lowest = TRUE, dig.lab = 10))|>
    count(tipo = capital_social_cat) |>
    dplyr::mutate(prop = percent(n/sum(n)),
                  tipo = fct_rev(tipo))|>
    ggplot(aes(x = tipo, y = n / 1e3)) +
    geom_col(fill = "gold", alpha = .9) +
    coord_flip() +
    geom_text(aes(label = prop), nudge_y = 3.5) +
    theme_minimal(14) +
    labs(x = "Capital social (milhares de reais)", 
         y = "Quantidade de empresas (milhares)")
```

# Porte a empresa 

- 01: Micro empresa
- 03: Empresa se pequeno Porte
- 05: Demais

```{r}
analise_survive|>
    left_join(empresas, "cnpj_basico")|>#View()
    ggplot(aes(porte))+
    geom_bar(fill = "gold")+
    theme_minimal(14) +
    labs(x = "Porte", 
         y = "´Quantidade de Empresas")
```


# Variáveis

As variáveis que iremos utilizar para medir o tempo de funcionamento das empresas serão

- Localização: interior ou capital
- Tipo de empreendimento: baseado na CNAE
- Capital Social da empresa. 

```{r}
df = analise_survive|>
      left_join(empresas, "cnpj_basico")|>
      left_join(cnae, by = c("cnae_fiscal_principal" = "cod_cnae" ))|>
      dplyr::mutate(
        censura = ifelse(data_situacao_cadastral == '2018-02-01' | 
                                data_situacao_cadastral == '2015-02-09', 0, 1),
        Região = case_when(id_municipio == 2211001 ~ "Capital",
                                      id_municipio != 2211001 ~ "Interior"),
                    capital_social_cat = cut(capital_social/1e3, 
                                           breaks = c(0, 1e3, 1e4, 1e5, 1e6, Inf)/1e3,
                                           include.lowest = TRUE, dig.lab = 10),
                    Periodo = lubridate::interval(data_inicio_atividade, 
                                                  data_situacao_cadastral)/years(1),
                    Periodo = round(Periodo, 0))|>
      dplyr::select(cnpj_basico, Região, capital_social, capital_social_cat, nm_grupo, nm_classe,
                    Periodo, censura)

df|>  
  head(10)|>
  kableExtra::kbl()|>
  kableExtra::kable_minimal()
```

## Região

```{r}
df|>
  group_by(Região)|>
  summarise(Empresas = n(), Media = round(mean(Periodo),2), Mediana = median(Periodo))
```

## CApital Social


```{r}
df|>
  dplyr::filter(capital_social > 0)|>
  group_by(capital_social_cat)|>
  summarise(Empresas = n(), Media = round(mean(Periodo),2), Mediana = median(Periodo))
```
## Tipo de empreendimento


```{r}
df|>
  #dplyr::filter(capital_social > 0)|>
  group_by(nm_classe)|>
  summarise(Empresas = n(), Media = round(mean(Periodo),2), Mediana = median(Periodo))|>
  dplyr::arrange(desc(Empresas))|>knitr::kable()
```


# Sobrevivência baseado no tipo de empresa

```{r}
library(survival)
library(survminer)

df1 = df|>
  dplyr::filter(nm_classe == "Comércio varejista de artigos do vestuário e acessórios")

km = survfit(Surv(Periodo, censura) ~ 1, df1)
summary(km)
```


```{r}
survminer::ggsurvplot(km, data = df1,  conf.int=TRUE)
```



# Referências


- https://www.cordeiroeaureliano.com.br/blog/post/fique-ligado/receita-divulga-relacao-de-baixa-de-cnpjs-mei/5125